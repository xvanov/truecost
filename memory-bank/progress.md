# TrueCost - Progress

## Current Status

**Phase**: Post-Merge Integration (Epic 6) + Production Readiness
**Sprint**: 1
**Date**: December 12, 2025
**Working Branch**: `bugfix/post-merge-integration`
**Primary Tracking**: `docs/sprint-artifacts/sprint-status.yaml`
**Local Dev**: ‚úÖ Running (Firebase emulators + Vite dev server)
**Test Status**:
- Python deep pipeline unit tests: **205 passing** (Epic 2)
- Repo-wide test count: **295+ passing** (per `docs/sprint-artifacts/sprint-1-completion-report.md`)

Recent pipeline change:
- User-selected cost defaults are now supported via `projectBrief.costPreferences` (overhead/profit/contingency/wasteFactor),
  and verified by a new unit test for CostAgent.
- Monte Carlo iterations used by RiskAgent are configurable via `MONTE_CARLO_ITERATIONS` (default: 10000).
- RiskAgent no longer invents `base_cost` when cost totals are missing; it returns N/A (`monteCarlo: null`, `contingency: null`) with `INSUFFICIENT_DATA`.
- TimelineAgent no longer uses hardcoded ‚Äúkitchen/bathroom/default remodel‚Äù task templates; tasks are generated by the LLM from user-defined scope + pipeline JSON.
- TimelineAgent no longer defaults start date to ‚Äú2 weeks from now‚Äù; it requires `projectBrief.timeline.desiredStart` from the Clarification JSON (otherwise returns N/A with an explicit error).
- TimelineCritic no longer enforces fixed remodel duration heuristics (e.g., ‚Äúsmall 20‚Äì30 / large 60‚Äì90 days‚Äù); critique is structural/consistency-based.
- Added `code_compliance` agent (ICC: IBC/IRC/IECC family) to generate code-related warnings; Final output now includes `codeCompliance.warnings`.
- Pipeline agent sequence is now 7 steps: `location ‚Üí scope ‚Üí code_compliance ‚Üí cost ‚Üí risk ‚Üí timeline ‚Üí final`.

---

## Merged Epics (Sprint 1)

- **Epic 1 (UI)**: merged (PR #16)
- **Epic 2 (Deep Agent Pipeline)**: merged (PR #17) ‚Äî 19 agents, 205 tests
- **Epic 4 (Data Services + PDF)**: merged (PR #14)
- **Epic 5 (Price Comparison)**: merged (PR #13)
- **Epic 3 (CAD + Voice)**: backlog

---

## Epic 6: Post-Merge Integration (Current)

Epic 6 wires the merged epics into a single end-to-end workflow (Projects ‚Üí Annotate ‚Üí Estimate):

- **6-1 Project persistence + Scope restructure**: ‚úÖ done
- **6-2 Estimate page (two-phase) + tabs + dual PDF**: üîÑ review

Key doc: `docs/sprint-artifacts/tech-spec-post-merge-integration.md`

---

## Deep Pipeline (Epic 2) PR Progress Tracker (Historical)

| PR | Branch | Description | Tests | Status | Completed |
|----|--------|-------------|-------|--------|-----------|
| #1 | `epic2/foundation` | Project setup, config, services | 58 | ‚úÖ Complete | Dec 10, 2025 |
| #2 | `epic2/clarification-validation` | ClarificationOutput models & parsing | 7 | ‚úÖ Complete | Dec 10, 2025 |
| #3 | `epic2/orchestrator` | Pipeline orchestrator & entry points | 15 | ‚úÖ Complete | Dec 10, 2025 |
| #4 | `ture-agent-pipeline` | Location Intelligence Agent | 26 | ‚úÖ Complete | Dec 11, 2025 |
| #5 | `epic2/scope-agent` | Construction Scope Agent | 29 | ‚úÖ Complete | Dec 11, 2025 |
| #6 | `epic2/cost-agent` | Cost Estimation Agent (P50/P80/P90) | 36 | ‚úÖ Complete | Dec 11, 2025 |
| #7 | `epic2/risk-final-agents` | Risk, Timeline & Final Agents | 33 | ‚úÖ Complete | Dec 11, 2025 |
| #8 | `epic2/firestore-rules` | Security rules, docs, integration mapping | - | ‚úÖ Complete | Dec 11, 2025 |

**Legend**: üî≤ Not Started | üîÑ In Progress | ‚úÖ Complete | ‚è∏Ô∏è Blocked

---

## What Exists (From CollabCanvas)

### Frontend (Complete - Being Extended by Dev 1)
- [x] React 19 + TypeScript + Vite setup
- [x] Firebase Auth with Google OAuth
- [x] Firestore integration patterns
- [x] Canvas-based annotation tools
- [x] BOM (Bill of Materials) infrastructure
- [x] Project management system
- [x] Zustand state management

### Cloud Functions (Existing TypeScript)
- [x] `aiCommand` - AI command processing
- [x] `materialEstimateCommand` - Material estimation
- [x] `getHomeDepotPrice` - Pricing API
- [x] `sagemakerInvoke` - AWS SageMaker integration

### Firebase Configuration
- [x] `firebase.json` - Hosting, Firestore, Storage, Functions (Python added)
- [x] `firestore.rules` - Security rules for projects/shapes/layers
- [x] Emulator configuration (ports 9099, 5001, 8081, 9199, 4000)

---

## What's Built for TrueCost

### Documentation (Complete)
- [x] PRD (`docs/prd.md`) - 78 functional requirements
- [x] Architecture (`docs/architecture.md`) - Technical decisions
- [x] Epic Breakdown (`docs/epics.md`) - 5 epics, 22 stories
- [x] ClarificationOutput Schema (`docs/clarification-output-schema.md`) v3.0.0
- [x] ClarificationOutput Example (`docs/clarification-output-example.json`)
- [x] UX Design Specification

### Memory Bank (Complete)
- [x] `projectbrief.md` - Foundation document
- [x] `productContext.md` - Why this project exists
- [x] `techContext.md` - Technology stack
- [x] `systemPatterns.md` - Architecture patterns
- [x] `activeContext.md` - Current work focus
- [x] `progress.md` - This file
- [x] `epic2-task-list.md` - Detailed PR breakdown

### Cursor Rules (Complete)
- [x] `.cursor/rules/epic2-deep-pipeline.mdc` - Epic 2 rules
- [x] `.cursor/rules/python-conventions.mdc` - Python conventions

---

## Epic 2 Story Progress

### Story 2.1: Pipeline Foundation & Orchestrator
**Status**: ‚úÖ Complete
**PRs**: #1, #2, #3

| Task | PR | Status |
|------|-----|--------|
| Create `functions/` directory structure | #1 | ‚úÖ |
| Create `requirements.txt` | #1 | ‚úÖ |
| Create configuration module (`settings.py`, `errors.py`) | #1 | ‚úÖ |
| Create Firestore service | #1 | ‚úÖ |
| Create LLM service wrapper | #1 | ‚úÖ |
| Create A2A client service | #1 | ‚úÖ |
| Create base agent class (BaseA2AAgent) | #1 | ‚úÖ |
| Create base scorer class (BaseScorer) | #1 | ‚úÖ |
| Create base critic class (BaseCritic) | #1 | ‚úÖ |
| Create agent cards registry (19 agents) | #1 | ‚úÖ |
| Unit tests for PR #1 (58 tests passing) | #1 | ‚úÖ |
| Create ClarificationOutput Pydantic models | #2 | ‚úÖ |
| Create `parse_clarification_output()` helper | #2 | ‚úÖ |
| Create test fixtures (kitchen, bathroom) | #2 | ‚úÖ |
| Unit tests for PR #2 (7 tests passing) | #2 | ‚úÖ |
| Create agent_output.py models | #3 | ‚úÖ |
| Create estimate.py models | #3 | ‚úÖ |
| Create orchestrator with AGENT_SEQUENCE | #3 | ‚úÖ |
| Implement `start_deep_pipeline` Cloud Function | #3 | ‚úÖ |
| Implement `delete_estimate` Cloud Function | #3 | ‚úÖ |
| Implement `get_pipeline_status` Cloud Function | #3 | ‚úÖ |
| Create 18 A2A endpoints (6 primary + 6 scorer + 6 critic) | #3 | ‚úÖ |
| Create 6 stub primary agents | #3 | ‚úÖ |
| Create 6 stub scorer agents | #3 | ‚úÖ |
| Create 6 stub critic agents | #3 | ‚úÖ |
| Unit tests for PR #3 (15 tests passing) | #3 | ‚úÖ |

### Story 2.2: Location Intelligence Agent
**Status**: ‚úÖ Complete
**PR**: #4
**Tests**: 26 passing

| Task | Status |
|------|--------|
| Create location factor models | ‚úÖ |
| Create mock cost data service | ‚úÖ |
| Implement Location Agent (real logic) | ‚úÖ |
| Implement Location Scorer (real logic) | ‚úÖ |
| Implement Location Critic (real logic) | ‚úÖ |
| Create mock location data fixtures | ‚úÖ |
| Unit tests | ‚úÖ |

**Files Created/Modified**:
- `functions/models/location_factors.py` - LaborRates, PermitCosts, WeatherFactors, LocationFactors
- `functions/services/cost_data_service.py` - Mock data for 6 metros
- `functions/agents/primary/location_agent.py` - Real LLM-powered agent
- `functions/agents/scorers/location_scorer.py` - 7-criteria scoring
- `functions/agents/critics/location_critic.py` - Actionable feedback
- `functions/tests/fixtures/mock_cost_data.py` - Test fixtures
- `functions/tests/unit/test_location_agent.py` - 26 unit tests

### Story 2.3: Construction Scope Agent
**Status**: ‚úÖ Complete
**PR**: #5
**Tests**: 29 passing

| Task | Status |
|------|--------|
| Create Bill of Quantities models | ‚úÖ |
| Add cost code lookup to service | ‚úÖ |
| Implement Scope Agent (real logic) | ‚úÖ |
| Implement Scope Scorer (real logic) | ‚úÖ |
| Implement Scope Critic (real logic) | ‚úÖ |
| Create mock BoQ fixtures | ‚úÖ |
| Unit tests | ‚úÖ |

**Files Created/Modified**:
- `functions/models/bill_of_quantities.py` - CostCode, UnitCostReference, EnrichedLineItem, EnrichedDivision, BillOfQuantities
- `functions/services/cost_data_service.py` - Added `get_cost_code()` for CSI MasterFormat lookup
- `functions/agents/primary/scope_agent.py` - Real LLM-powered agent (replaced stub)
- `functions/agents/scorers/scope_scorer.py` - 6-criteria scoring (replaced stub)
- `functions/agents/critics/scope_critic.py` - Actionable feedback (replaced stub)
- `functions/tests/fixtures/mock_boq_data.py` - Test fixtures
- `functions/tests/unit/test_scope_agent.py` - 29 unit tests

### Story 2.4: Cost Estimation Agent
**Status**: ‚úÖ Complete
**PR**: #6
**Tests**: 36 passing

| Task | Status |
|------|--------|
| Create `models/cost_estimate.py` with CostRange (P50/P80/P90) | ‚úÖ |
| Add `get_material_cost()` with cost ranges | ‚úÖ |
| Add `get_labor_rate()` with cost ranges | ‚úÖ |
| Implement Cost Agent (real logic) | ‚úÖ |
| Implement Cost Scorer (range validation) | ‚úÖ |
| Implement Cost Critic (cost feedback) | ‚úÖ |
| Create mock cost estimate fixtures | ‚úÖ |
| Unit tests (36) | ‚úÖ |

**Files Created/Modified**:
- `functions/models/cost_estimate.py` - CostRange (P50/P80/P90), LineItemCost, CostSubtotals, CostAdjustments, CostEstimate, CostSummary
- `functions/services/cost_data_service.py` - Added `get_material_cost()`, `get_labor_rate()`, `get_equipment_cost()` with P50/P80/P90 ranges
- `functions/agents/primary/cost_agent.py` - Real LLM-powered agent with 3-tier cost output (replaced stub)
- `functions/agents/scorers/cost_scorer.py` - 6-criteria scoring for range validation (replaced stub)
- `functions/agents/critics/cost_critic.py` - Actionable feedback for cost issues (replaced stub)
- `functions/tests/fixtures/mock_cost_estimate_data.py` - Test fixtures
- `functions/tests/unit/test_cost_agent.py` - 36 unit tests

**Key Feature: 3-Tier Cost Output (P50/P80/P90)**:
- P50 (low): Median estimate - 50th percentile
- P80 (medium): Conservative estimate - 80th percentile  
- P90 (high): Pessimistic estimate - 90th percentile
- Uses variance multipliers (1.0/1.15/1.25) for Monte Carlo compatibility

### Story 2.5: Risk Analysis, Timeline & Final Estimator Agent
**Status**: ‚úÖ Complete
**PR**: #7
**Tests**: 33 passing

| Task | Status |
|------|--------|
| Create risk analysis models | ‚úÖ |
| Create timeline models | ‚úÖ |
| Create final estimate models | ‚úÖ |
| Create mock Monte Carlo service | ‚úÖ |
| Implement Risk Agent (real logic) | ‚úÖ |
| Implement Risk Scorer (real logic) | ‚úÖ |
| Implement Risk Critic (real logic) | ‚úÖ |
| Implement Timeline Agent (real logic) | ‚úÖ |
| Implement Timeline Scorer (real logic) | ‚úÖ |
| Implement Timeline Critic (real logic) | ‚úÖ |
| Implement Final Agent (real logic) | ‚úÖ |
| Implement Final Scorer (real logic) | ‚úÖ |
| Implement Final Critic (real logic) | ‚úÖ |
| Integration test (full pipeline) | ‚úÖ |
| Unit tests (33) | ‚úÖ |

**Files Created/Modified**:
- `functions/models/risk_analysis.py` - RiskFactor, CostImpact, Probability, PercentileValues, MonteCarloResult, RiskAnalysisSummary, RiskAnalysis
- `functions/models/timeline.py` - DurationRange, TimelineTask, Milestone, CriticalPath, ProjectTimeline
- `functions/models/final_estimate.py` - ExecutiveSummary, CostBreakdownSummary, TimelineSummary, RiskSummary, FinalEstimate
- `functions/services/monte_carlo_service.py` - Mock Monte Carlo with NumPy triangular distributions
- `functions/agents/primary/risk_agent.py` - Real LLM-powered agent with Monte Carlo (replaced stub)
- `functions/agents/scorers/risk_scorer.py` - 4-criteria scoring (replaced stub)
- `functions/agents/critics/risk_critic.py` - Actionable feedback (replaced stub)
- `functions/agents/primary/timeline_agent.py` - Real LLM-powered agent (replaced stub)
- `functions/agents/scorers/timeline_scorer.py` - 4-criteria scoring (replaced stub)
- `functions/agents/critics/timeline_critic.py` - Actionable feedback (replaced stub)
- `functions/agents/primary/final_agent.py` - Real LLM-powered synthesis agent (replaced stub)
- `functions/agents/scorers/final_scorer.py` - 4-criteria scoring (replaced stub)
- `functions/agents/critics/final_critic.py` - Actionable feedback (replaced stub)
- `functions/tests/fixtures/mock_risk_timeline_data.py` - Test fixtures
- `functions/tests/unit/test_risk_timeline_final.py` - 33 unit tests

---

## Dependencies on Other Teams

| Dependency | From | Status | Notes |
|------------|------|--------|-------|
| `ClarificationOutput` v3.0.0 | Dev 3 | ‚úÖ Schema defined | Example JSON available |
| `cost_data_service.get_location_factors()` | Dev 4 | üî≤ Not started | Will mock |
| `cost_data_service.get_material_cost()` | Dev 4 | üî≤ Not started | Will mock |
| `monte_carlo.run_simulation()` | Dev 4 | üî≤ Not started | Will mock |

---

## Known Issues

- Historical branch name typo: `ture-agent-pipeline` instead of `true-agent-pipeline`
- Dual-collection reality:
  - UI uses `/projects/{projectId}` and watches `/projects/{projectId}/pipeline/status`
  - Deep pipeline writes `/estimates/{estimateId}` (+ `/costItems` subcollection)
  - Integration depends on passing `projectId` into Python `start_deep_pipeline`

---

## Blockers

- None currently

---

## Next Actions

1. Verify end-to-end **Projects flow** uses the TS callable orchestrator and receives progress updates:
   - `collabcanvas/functions/src/estimatePipelineOrchestrator.ts`
   - `functions/services/firestore_service.py::sync_to_project_pipeline()`
2. Verify `get_pipeline_status` remains dashboard-safe:
   - Firestore timestamps serialize correctly to JSON
   - Response injects full `finalOutput.granularCostItems.items` (no truncation)

## Test Summary

| PR | Tests | Status |
|----|-------|--------|
| PR #1 | 58 | ‚úÖ All passing |
| PR #2 | 7 | ‚úÖ All passing |
| PR #3 | 15 | ‚úÖ All passing |
| PR #4 | 26 | ‚úÖ All passing |
| PR #5 | 29 | ‚úÖ All passing |
| PR #6 | 36 | ‚úÖ All passing |
| PR #7 | 33 | ‚úÖ All passing |
| **Total** | **205** | ‚úÖ All passing |

## Local Development Setup

‚úÖ **Complete**:
- Firebase emulators running on ports: 9099 (Auth), 5001 (Functions), 8081 (Firestore), 9199 (Storage), 4000 (UI)
- Vite dev server running
- Functions dependencies installed (`functions/`)
- Frontend dependencies installed (`collabcanvas/`)
- Environment variable set: `VITE_USE_FIREBASE_EMULATORS=true`

---

## Recent Changes (Post PR #8)

### Granular Cost Ledger (Cost Items)
- Added Firestore subcollection `/estimates/{estimateId}/costItems` for high-granularity cost components
- `CostAgent` writes granular component records during costing (material/labor/equipment + heuristic plank counts)
- `FinalAgent` writes metadata (`costItemsCount`, `costItemsCollectionPath`) to the root estimate for discovery
- `get_pipeline_status` now injects full `finalOutput.granularCostItems.items` for UI display (no truncation in API response)

### Dashboard + API Stability
- `functions/pipeline_dashboard.html` displays the cost ledger and reads from the `costItems` subcollection
- Fixed `get_pipeline_status` 500s caused by Firestore timestamp objects not being JSON serializable (now serialized to ISO strings)

### Test/Dev Ergonomics
- Pytest import stability: `functions/tests/conftest.py` ensures `functions/` is on `sys.path` so imports like `from models...` work reliably
- FirestoreService supports both sync firebase-admin calls and AsyncMock behavior in tests

---

_Last Updated: December 12, 2025 (Post-merge integration branch; Epic 6 tracked in sprint artifacts)_
